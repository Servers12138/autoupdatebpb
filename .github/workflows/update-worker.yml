name: Update Worker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥ä»“åº“
        uses: actions/checkout@v3

      - name: åˆ é™¤æ—§æ–‡ä»¶
        run: |
          rm -rf ./*

      - name: ä¸‹è½½å¹¶è§£å‹ BPB-Worker-Panel
        run: |
          curl -L https://github.com/xyTom/bpb-worker-panel/archive/refs/heads/main.zip -o main.zip
          unzip -o main.zip
          mv bpb-worker-panel-main/* ./
          rm -rf bpb-worker-panel-main main.zip

      # ğŸ”¥ è‡ªåŠ¨æ‰“è¡¥ä¸ï¼šåœ¨ _worker.js å¼€å¤´æ’å…¥ getIPList() é€»è¾‘
      - name: ç»™ _worker.js æ‰“è¡¥ä¸ï¼ˆæ·»åŠ  ip.txt è¯»å–åŠŸèƒ½ï¼‰
        run: |
          if [ -f "_worker.js" ]; then
            cat << 'EOF' > patch.js
// ====== è‡ªåŠ¨è¯»å– ip.txt åŠŸèƒ½å¼€å§‹ ======
async function getIPList() {
  try {
    let resp = await fetch("https://private.zzjay.pp.ua/ip.txt");
    let text = await resp.text();
    return text.split("\n").filter(line => line.trim() !== "");
  } catch (e) {
    return [];
  }
}
// ====== è‡ªåŠ¨è¯»å– ip.txt åŠŸèƒ½ç»“æŸ ======
EOF
            cat patch.js _worker.js > _worker.js.new
            mv _worker.js.new _worker.js
          fi

      - name: æäº¤æ›´æ”¹åˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "è‡ªåŠ¨æ›´æ–° Worker ä»£ç å¹¶æ·»åŠ  ip.txt è¯»å–åŠŸèƒ½" || echo "No changes to commit"
          git push
